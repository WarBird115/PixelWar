<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pixel Wars</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <h1>Pixel Wars</h1>

  <canvas id="canvas" width="400" height="400"></canvas>

  <input type="color" id="colorPicker" value="#000000">
  <input type="password" id="passwordInput" placeholder="Enter password">
  <button id="submitPassword">Submit</button>
  <button id="clearCanvasButton" style="display: none;">Clear Canvas</button>

  <div id="cooldown-timer">You can place a pixel now!</div>

  <div id="welcomeText">
    <h2>Welcome to Pixel Wars!</h2>
    <p>This space is all about collaboration and creativity. Go wild, be quirky, or team up with others to create something amazing. The image you create here will become our server banner at the end of every month. You've got one pixel every 5 minutes, so make it count!</p>
    <p>Here are some quick tips to get you started:</p>
    <ul>
      <li>Click on the canvas to place a pixel.</li>
      <li>You can replace any pixel, no matter who placed it there!</li>
    </ul>
    <p>Game on and happy pixeling!</p>
  </div>

  <div id="user-password" style="display: none; margin-top: 20px;">
    User Password: <span id="display-password"></span>
  </div>

  <div id="firebase-version" style="margin-top: 20px;">
    Firebase Version: <span id="firebase-version-text"></span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js";
    const CryptoJS = window.CryptoJS;

    const firebaseConfig = {
      apiKey: "AIzaSyCjcSLUJsjQWmITFt3gQCul9BcNs1ABTpA",
      authDomain: "pixelwarnew.firebaseapp.com",
      databaseURL: "https://pixelwarnew-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "pixelwarnew",
      storageBucket: "pixelwarnew.appspot.com",
      messagingSenderId: "312098433016",
      appId: "1:312098433016:web:0edcc62b292cb41546580d",
      measurementId: "G-9VH085RDE1"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Display Firebase version
    const firebaseVersion = "9.21.0"; // Change this to match your version
    document.getElementById('firebase-version-text').textContent = firebaseVersion;

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const cooldownTimer = document.getElementById('cooldown-timer');
    const adminPassword = "The0verseer"; // Admin password (constant)
    const pixelSize = 10; // Pixel size, adjustable
    const cooldownDuration = 5 * 60 * 1000; // 5 minutes cooldown
    let cooldownEndTime = null;
    let isUserAuthenticated = false; // Track user authentication status

    // Function to generate a random alphanumeric password
    function generateRandomPassword() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let password = '';
      for (let i = 0; i < 5; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return password;
    }

    // Encrypt password using AES
    function encryptPassword(password) {
      return CryptoJS.AES.encrypt(password, 'your-secret-key').toString();
    }

    // Decrypt password
    function decryptPassword(encryptedPassword) {
      const bytes = CryptoJS.AES.decrypt(encryptedPassword, 'your-secret-key');
      return bytes.toString(CryptoJS.enc.Utf8);
    }

    // Function to set weekly user password
    function setWeeklyUserPassword() {
      const now = new Date();
      const currentWeek = now.getFullYear() + "-W" + getWeekNumber(now);
      const userPassword = generateRandomPassword(); // Generate a new password
      return userPassword; // Return newly generated password for this week
    }

    // Get current week number
    function getWeekNumber(date) {
      const firstJan = new Date(date.getFullYear(), 0, 1);
      const days = Math.floor((date - firstJan) / (24 * 60 * 60 * 1000));
      return Math.ceil((days + firstJan.getDay() + 1) / 7);
    }

    // Set canvas size
    const canvasWidth = 400;
    const canvasHeight = 400;
    canvas.width = canvasWidth;
    canvas.height = canvasHeight;

    // Check for cooldown in localStorage
    const savedCooldownEndTime = localStorage.getItem('cooldownEndTime');
    if (savedCooldownEndTime && Date.now() < savedCooldownEndTime) {
      cooldownEndTime = parseInt(savedCooldownEndTime, 10);
      updateCooldownTimer();
    }

    // Function to update the cooldown timer
    function updateCooldownTimer() {
      const interval = setInterval(() => {
        const remainingTime = cooldownEndTime - Date.now();
        if (remainingTime > 0) {
          const minutes = Math.floor(remainingTime / 1000 / 60);
          const seconds = Math.floor((remainingTime / 1000) % 60);
          cooldownTimer.textContent = `Next pixel in: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        } else {
          clearInterval(interval);
          cooldownEndTime = null;
          cooldownTimer.textContent = 'You can place a pixel now!';
          localStorage.removeItem('cooldownEndTime');
        }
      }, 1000);
    }

    // Color Picker
    const colorPicker = document.getElementById('colorPicker');
    let currentColor = colorPicker.value;
    colorPicker.addEventListener('input', () => {
      currentColor = colorPicker.value;
    });

    // Canvas click to place a pixel
    canvas.addEventListener('click', (e) => {
      if (!isUserAuthenticated) {
        alert('You must enter the correct password to place a pixel!');
        return;
      }

      if (cooldownEndTime && Date.now() < cooldownEndTime) {
        alert('You are still on cooldown!');
        return;
      }

      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / pixelSize);
      const y = Math.floor((e.clientY - rect.top) / pixelSize);

      ctx.fillStyle = currentColor;
      ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);

      const pixelRef = ref(database, `pixels/${x},${y}`);
      set(pixelRef, { color: currentColor }).then(() => {
        console.log('Pixel saved');
      }).catch((error) => {
        console.error('Error saving pixel:', error);
      });

      cooldownEndTime = Date.now() + cooldownDuration;
      localStorage.setItem('cooldownEndTime', cooldownEndTime);
      updateCooldownTimer();
    });

    // Password submission
    document.getElementById('submitPassword').addEventListener('click', () => {
      const passwordInput = document.getElementById('passwordInput').value;

      console.log('Password Input:', passwordInput); // Log the entered password

      if (passwordInput === adminPassword) {
        document.getElementById('clearCanvasButton').style.display = 'inline';
        alert('Admin access granted. You can now clear the canvas.');
        isUserAuthenticated = true;

        // Generate the weekly password for admin only
        const userPassword = setWeeklyUserPassword(); // Generate the weekly password
        console.log('Weekly User Password (for Admin):', userPassword); // Log the decrypted password
        
        // Display the user password on the webpage
        document.getElementById('display-password').textContent = userPassword;
        document.getElementById('user-password').style.display = 'block';
      } else if (passwordInput === setWeeklyUserPassword()) {
        isUserAuthenticated = true;
        alert('You can now place a pixel!');
      } else {
        alert('Incorrect password. Please try again.');
      }
    });

    // Clear Canvas button functionality
    document.getElementById('clearCanvasButton').addEventListener('click', () => {
      const pixelsRef = ref(database, 'pixels');
      remove(pixelsRef).then(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        alert('Canvas cleared!');
      }).catch((error) => {
        console.error('Error clearing canvas:', error);
      });
    });

    // Firebase data listener for pixels
    onValue(ref(database, 'pixels'), (snapshot) => {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas first
      snapshot.forEach(childSnapshot => {
        const pixelData = childSnapshot.val();
        const coords = childSnapshot.key.split(',');
        ctx.fillStyle = pixelData.color;
        ctx.fillRect(coords[0] * pixelSize, coords[1] * pixelSize, pixelSize, pixelSize);
      });
    });

  </script>
</body>
</html>
